<?xml version="1.0" encoding="UTF-8"?>
<?asciidoc-toc?>
<?asciidoc-numbered?>
<book xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en">
<info>
<title>Project</title>
<subtitle>Multi-Package Workspace &amp; Vendor</subtitle>
<date>2025-11-15</date>
<copyright>
<holder>zigbook</holder>
</copyright>
</info>
<chapter xml:id="overview">
<title>Overview</title>
<simpara><link xl:href="26__build-system-advanced-topics.xml">Chapter 26</link> explored advanced <literal>std.Build</literal> techniques for coordinating workspaces and matrix builds. This project chapter puts those tools to work: we will assemble a three-package workspace featuring two reusable libraries, a vendored ANSI palette, and an application that renders a latency dashboard. Along the way, we capture metadata with named write-files and install the artefact into <literal>zig-out</literal>, demonstrating how vendor-first workflows coexist with registry-ready modules (see <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/Build.zig">Build.zig</link> and <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/Build/Step/InstallDir.zig">Dir.zig</link>).</simpara>
<simpara>The example is intentionally compact yet realistic—<literal>libA</literal> performs statistical analysis, <literal>libB</literal> formats status lines, and the vendored palette keeps terminal colouring private to the workspace. The build graph registers only the contracts we want consumers to see, mirroring the hygiene rules from the previous concept chapters. <link xl:href="25__module-resolution-and-discovery-deep.xml">25</link></simpara>
</chapter>
<chapter xml:id="learning-goals">
<title>Learning Goals</title>
<itemizedlist>
<listitem>
<simpara>Wire multiple libraries and a vendored helper into a single workspace using a shared <literal>deps.zig</literal> registration function (see <link xl:href="26__build-system-advanced-topics.xml">26</link> and <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/Build/Module.zig">Module.zig</link>).</simpara>
</listitem>
<listitem>
<simpara>Generate reproducible artefacts (a dependency map) with named write-files and install them into <literal>zig-out</literal> for CI inspection (see <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/Build/Step/WriteFile.zig">File.zig</link>).</simpara>
</listitem>
<listitem>
<simpara>Validate component libraries through <literal>zig build test</literal>, ensuring vendored code participates in the same test harness as registry packages (see <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/testing.zig">testing.zig</link>).</simpara>
</listitem>
<listitem>
<simpara>Apply Zig 0.15.2’s buffered writer API in an application that consumes the workspace modules (see <link xl:href="https://ziglang.org/download/0.15.1/release-notes.html#upgrading-stdiogetstdoutwriterprint">#upgrading stdiogetstdoutwriterprint</link>).</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter xml:id="workspace-blueprint">
<title>Workspace blueprint</title>
<simpara>The workspace lives under <literal>chapters-data/code/27__project-multi-package-workspace-and-vendor/</literal>. A minimal manifest declares the package name and the directories that should ship with any release, keeping vendored sources explicit (see <link xl:href="https://github.com/ziglang/zig/blob/master/lib/init/build.zig.zon">build.zig.zon template</link>).</simpara>
<section xml:id="manifest-layout">
<title>Manifest and layout</title>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/build.zig.zon[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig build --build-file build.zig map</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">no output</programlisting>
</para>
</formalpara>
<tip>
<simpara>Running <literal>map</literal> installs <literal>zig-out/workspace-artifacts/dependency-map.txt</literal>, making the package surface auditable without combing through source trees.</simpara>
</tip>
</section>
<section xml:id="deps-pattern">
<title>Wiring packages with <literal>deps.zig</literal></title>
<simpara><literal>deps.zig</literal> centralises module registration so every consumer—tests, executables, or future examples—receives the same wiring. We register <literal>libA</literal> and <literal>libB</literal> under public names, while the ANSI palette stays anonymous via <literal>b.createModule</literal>.</simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/deps.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig build --build-file build.zig test</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">no output</programlisting>
</para>
</formalpara>
<important>
<simpara>Returning module handles keeps callers honest—only <literal>build.zig</literal> decides which names become public imports, an approach that aligns with the namespace rules from Chapter 25. <link xl:href="25__module-resolution-and-discovery-deep.xml">25</link></simpara>
</important>
</section>
<section xml:id="build-orchestration">
<title>Build graph orchestration</title>
<simpara>The build script installs the executable, exposes <literal>run</literal>, <literal>test</literal>, and <literal>map</literal> steps, and copies the generated dependency map into <literal>zig-out/workspace-artifacts/</literal>.</simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/build.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig build --build-file build.zig run</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">dataset      status    mean       range      samples
------------------------------------------------------
frontend     stable    111.80     3.90       5
checkout     stable    100.60     6.40       5
analytics    alert     77.42      24.00      5</programlisting>
</para>
</formalpara>
<note>
<simpara>The dependency map written by the <literal>map</literal> step renders as:</simpara>
</note>
<screen>Modules registered in build.zig:
  libA      -&gt; packages/libA/analytics.zig
  libB      -&gt; packages/libB/report.zig (imports libA, palette)
  palette   -&gt; vendor/palette/palette.zig (anonymous)
  executable -&gt; app/main.zig</screen>
</section>
</chapter>
<chapter xml:id="library-modules">
<title>Library modules</title>
<simpara>Two libraries share responsibility: <literal>libA</literal> performs numeric analysis, <literal>libB</literal> transforms those statistics into colour-coded rows. Tests live alongside each module so the build graph can execute them without additional glue.</simpara>
<section xml:id="libA-analytics">
<title>Analytics core (<literal>libA</literal>)</title>
<simpara><literal>libA</literal> implements Welford’s algorithm for stable variance computation and exposes convenience helpers such as <literal>relativeSpread</literal> and <literal>zScore</literal>. <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/math.zig">math.zig</link></simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/packages/libA/analytics.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig test packages/libA/analytics.zig</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">All 1 tests passed.</programlisting>
</para>
</formalpara>
</section>
<section xml:id="libB-report">
<title>Reporting surface (<literal>libB</literal>)</title>
<simpara><literal>libB</literal> depends on <literal>libA</literal> for statistics and the vendored palette for styling. It computes a status label per dataset and renders a compact table suitable for dashboards or CI logs.</simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/packages/libB/report.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig build --build-file build.zig test</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">no output</programlisting>
</para>
</formalpara>
<tip>
<simpara>Testing through <literal>zig build test</literal> ensures the module sees <literal>libA</literal> and the palette via the same imports the executable uses, eliminating discrepancies between direct <literal>zig test</literal> runs and build-orchestrated runs.</simpara>
</tip>
</section>
<section xml:id="vendor-palette">
<title>Vendored theme palette</title>
<simpara>The ANSI palette stays private to the workspace—<literal>deps.zig</literal> injects it where needed without registering a public name. This keeps colour codes stable even if the workspace later consumes a registry dependency with conflicting helpers.</simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/vendor/palette/palette.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig test vendor/palette/palette.zig</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">All 1 tests passed.</programlisting>
</para>
</formalpara>
</section>
</chapter>
<chapter xml:id="application-entry">
<title>Application entry point</title>
<simpara>The executable imports only the public modules, builds datasets, and prints the table using the buffered writer API introduced in Zig 0.15.2.</simpara>
<programlisting language="zig" linenumbering="unnumbered">Unresolved directive in 27__project-multi-package-workspace-and-vendor.adoc - include::example$chapters-data/code/27__project-multi-package-workspace-and-vendor/app/main.zig[]</programlisting>
<formalpara>
<title>Run</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">$ zig build --build-file build.zig run</programlisting>
</para>
</formalpara>
<formalpara>
<title>Output</title>
<para>
<programlisting language="shell" linenumbering="unnumbered">dataset      status     mean       range      samples
------------------------------------------------------
frontend     stable     111.80     3.90       5
checkout     stable     100.60     6.40       5
analytics    alert      77.42      24.00      5</programlisting>
</para>
</formalpara>
</chapter>
<chapter xml:id="notes-caveats">
<title>Notes &amp; Caveats</title>
<itemizedlist>
<listitem>
<simpara>The workspace exposes only <literal>libA</literal> and <literal>libB</literal>; vendored modules remain anonymous thanks to <literal>b.createModule</literal>, preventing downstream consumers from relying on internal helpers.</simpara>
</listitem>
<listitem>
<simpara>Named write-files produce deterministic artefacts. Pair the <literal>map</literal> step with CI to detect accidental namespace changes before they reach production.</simpara>
</listitem>
<listitem>
<simpara><literal>zig build test</literal> composes multiple module tests under a single command; if you add new packages, remember to thread their modules through <literal>deps.zig</literal> so they join the suite.</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter xml:id="exercises">
<title>Exercises</title>
<itemizedlist>
<listitem>
<simpara>Extend the dependency map to emit JSON alongside the text file. Hint: add a second <literal>mapping.add("dependency-map.json", &#8230;&#8203;)</literal> and reuse <literal>std.json</literal> to serialise the structure. <link xl:href="26__build-system-advanced-topics.xml">26</link>, <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/json.zig">json.zig</link></simpara>
</listitem>
<listitem>
<simpara>Add a registry dependency via <literal>b.dependency("logger", .{})</literal>, re-export its module in <literal>deps.zig</literal>, and update the map to document the new namespace. <link xl:href="24__zig-package-manager-deep.xml">24</link></simpara>
</listitem>
<listitem>
<simpara>Introduce a <literal>-Dalert-spread</literal> option that overrides the default thresholds. Forward the option through <literal>deps.zig</literal> so both the executable and any tests see the same policy.</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter xml:id="caveats-alternatives-edge-cases">
<title>Caveats, alternatives, edge cases</title>
<itemizedlist>
<listitem>
<simpara>When the vendored palette eventually graduates to a standalone package, swap <literal>b.createModule</literal> for <literal>b.addModule</literal> and list it in <literal>build.zig.zon</literal> to ensure consumers fetch it via hashes.</simpara>
</listitem>
<listitem>
<simpara>If your workspace grows beyond a handful of modules, consider grouping registries in <literal>deps.zig</literal> by responsibility (<literal>observability</literal>, <literal>storage</literal>, etc.) so the build script stays navigable. <link xl:href="26__build-system-advanced-topics.xml">26</link></simpara>
</listitem>
<listitem>
<simpara>Cross-compiling the dashboard requires ensuring each target supports ANSI escapes; gate palette usage behind <literal>builtin.os.tag</literal> checks if you ship to Windows consoles without VT processing. <link xl:href="https://github.com/ziglang/zig/tree/master/lib/std/builtin.zig">builtin.zig</link></simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter xml:id="summary">
<title>Summary</title>
<itemizedlist>
<listitem>
<simpara><literal>deps.zig</literal> centralises module registration, enabling repeatable workspaces that expose only sanctioned namespaces.</simpara>
</listitem>
<listitem>
<simpara>Named write-files and install directories turn build metadata into versionable artefacts ready for CI checks.</simpara>
</listitem>
<listitem>
<simpara>A vendored helper can coexist with reusable libraries, keeping internal colour schemes private while the public API remains clean.</simpara>
</listitem>
</itemizedlist>
<simpara>With this project you now have a concrete template for organising multi-package Zig workspaces, balancing vendored code with reusable libraries while keeping the build graph transparent and testable.</simpara>
</chapter>
</book>